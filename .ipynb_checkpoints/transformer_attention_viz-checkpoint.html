<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Self-Attention Visualization</title>
    <style>
        body {
            margin: 0;
            padding: 20px;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f8f9fa;
            color: #2c3e50;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        h1 {
            text-align: center;
            color: #2c3e50;
            margin-bottom: 10px;
        }
        
        .subtitle {
            text-align: center;
            color: #7f8c8d;
            margin-bottom: 30px;
        }
        
        .sentence-display {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            text-align: center;
        }
        
        .word {
            display: inline-block;
            padding: 8px 12px;
            margin: 4px;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s ease;
            border: 2px solid transparent;
            font-weight: 500;
        }
        
        .word:hover {
            background: #ecf0f1;
        }
        
        .word.selected {
            background: #3498db;
            color: white;
            border: 2px solid #2980b9;
        }
        
        .attention-container {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .attention-matrix {
            flex: 1;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .matrix-header {
            font-weight: bold;
            margin-bottom: 15px;
            color: #2c3e50;
        }
        
        .matrix-grid {
            display: grid;
            grid-template-columns: 80px repeat(11, 1fr);
            gap: 2px;
            font-size: 12px;
        }
        
        .matrix-cell {
            padding: 8px 4px;
            text-align: center;
            border-radius: 3px;
            transition: all 0.2s ease;
        }
        
        .matrix-cell.header {
            background: #34495e;
            color: white;
            font-weight: bold;
        }
        
        .matrix-cell.row-label {
            background: #34495e;
            color: white;
            font-weight: bold;
            text-align: right;
            padding-right: 8px;
        }
        
        .matrix-cell.attention {
            background: #ecf0f1;
            cursor: pointer;
        }
        
        .matrix-cell.attention:hover {
            transform: scale(1.1);
            z-index: 10;
            position: relative;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }
        
        .math-panel {
            flex: 0 0 400px;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .math-step {
            margin-bottom: 20px;
        }
        
        .step-title {
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 10px;
        }
        
        .formula {
            background: #f8f9fa;
            padding: 10px;
            border-left: 4px solid #3498db;
            font-family: 'Courier New', monospace;
            margin: 10px 0;
        }
        
        .highlight {
            background: #f1c40f;
            padding: 2px 4px;
            border-radius: 2px;
            font-weight: bold;
        }
        
        .controls {
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            text-align: center;
        }
        
        .step-buttons {
            margin: 10px 0;
        }
        
        .step-btn {
            background: #95a5a6;
            border: none;
            color: white;
            padding: 8px 15px;
            margin: 0 5px;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .step-btn:hover {
            background: #7f8c8d;
        }
        
        .step-btn.active {
            background: #e74c3c;
        }
        
        .legend {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 15px;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .legend-color {
            width: 16px;
            height: 16px;
            border-radius: 2px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Self-Attention Visualization</h1>
        <p class="subtitle">Interactive exploration of how transformers understand word relationships</p>
        
        <div class="sentence-display">
            <div id="sentence-words"></div>
        </div>
        
        <div class="attention-container">
            <div class="attention-matrix">
                <div class="matrix-header">Attention Matrix: Hover over cells to see attention weights</div>
                <div class="matrix-grid" id="attention-grid"></div>
            </div>
            
            <div class="math-panel">
                <div id="math-content">
                    <div class="math-step">
                        <div class="step-title">Self-Attention Calculation</div>
                        <p>Click on different words to see how they attend to other words in the sentence.</p>
                        <div class="formula">
Attention(Q,K,V) = softmax(QK^T/√d_k)V
                        </div>
                        <p>The matrix shows attention weights - how much each word "looks at" every other word when building its representation.</p>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="controls">
            <div>
                <strong>Selected word:</strong> <span id="current-word">it</span> | 
                <strong>Step:</strong> <span id="current-step">Final Attention</span>
            </div>
            <div class="step-buttons">
                <button class="step-btn" data-step="0">1. Query×Key</button>
                <button class="step-btn" data-step="1">2. Scale (÷√64)</button>
                <button class="step-btn" data-step="2">3. Softmax</button>
                <button class="step-btn active" data-step="3">4. Final Attention</button>
            </div>
            <div class="legend">
                <div class="legend-item">
                    <div class="legend-color" style="background: #2c3e50;"></div>
                    <span>No attention (0.00)</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #95a5a6;"></div>
                    <span>Low (0.01-0.10)</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #f39c12;"></div>
                    <span>Medium (0.11-0.30)</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #e74c3c;"></div>
                    <span>High (0.31+)</span>
                </div>
            </div>
        </div>
    </div>

    <script>
        const sentence = ["The", "animal", "didn't", "cross", "the", "street", "because", "it", "was", "too", "tired"];
        
        // Realistic attention weights - showing how "it" strongly attends to "animal"
        const attentionData = {
            rawScores: [
                [12.3, 8.4, 6.7, 7.1, 11.8, 9.2, 8.9, 10.5, 9.8, 8.6, 9.1],
                [7.2, 45.8, 8.3, 9.1, 6.4, 11.2, 7.8, 6.9, 5.1, 4.3, 4.8],
                [8.1, 12.4, 38.2, 15.7, 7.9, 14.3, 11.2, 8.6, 6.4, 4.2, 4.1],
                [6.8, 14.2, 10.9, 42.1, 7.1, 19.8, 8.3, 6.2, 4.1, 3.2, 3.4],
                [5.9, 8.7, 6.4, 7.8, 35.2, 24.1, 13.1, 9.8, 5.8, 4.2, 3.9],
                [5.8, 16.3, 7.2, 23.7, 10.1, 28.9, 8.4, 9.1, 4.2, 3.1, 3.2],
                [6.7, 11.8, 14.2, 8.9, 7.4, 8.8, 37.2, 16.3, 6.1, 4.2, 4.4],
                [6.1, 51.2, 7.3, 6.8, 5.2, 11.4, 8.9, 23.8, 4.8, 3.1, 3.4], // "it" row
                [7.8, 13.9, 10.1, 8.7, 6.2, 7.1, 10.8, 18.9, 31.2, 5.8, 4.5],
                [6.4, 11.2, 8.9, 7.1, 5.1, 6.3, 8.8, 13.7, 16.2, 37.8, 5.5],
                [5.2, 24.1, 7.4, 6.8, 4.9, 7.2, 8.1, 11.3, 13.8, 16.9, 19.3]
            ]
        };
        
        let currentWord = 7; // "it"
        let currentStep = 3; // Final attention
        
        function initializeDisplay() {
            // Create sentence display
            const sentenceContainer = document.getElementById('sentence-words');
            sentence.forEach((word, i) => {
                const wordEl = document.createElement('span');
                wordEl.className = 'word';
                wordEl.textContent = word;
                wordEl.dataset.index = i;
                if (i === currentWord) wordEl.classList.add('selected');
                
                wordEl.addEventListener('click', () => selectWord(i));
                sentenceContainer.appendChild(wordEl);
            });
            
            // Create attention matrix
            createAttentionMatrix();
            updateMathPanel();
        }
        
        function selectWord(index) {
            currentWord = index;
            
            // Update sentence display
            document.querySelectorAll('.word').forEach((el, i) => {
                el.classList.toggle('selected', i === index);
            });
            
            document.getElementById('current-word').textContent = sentence[index];
            updateAttentionMatrix();
            updateMathPanel();
        }
        
        function createAttentionMatrix() {
            const grid = document.getElementById('attention-grid');
            grid.innerHTML = '';
            
            // Header row
            const emptyCell = document.createElement('div');
            emptyCell.className = 'matrix-cell header';
            grid.appendChild(emptyCell);
            
            sentence.forEach(word => {
                const cell = document.createElement('div');
                cell.className = 'matrix-cell header';
                cell.textContent = word;
                grid.appendChild(cell);
            });
            
            // Data rows
            sentence.forEach((word, i) => {
                // Row label
                const rowLabel = document.createElement('div');
                rowLabel.className = 'matrix-cell row-label';
                rowLabel.textContent = word;
                grid.appendChild(rowLabel);
                
                // Attention cells
                sentence.forEach((_, j) => {
                    const cell = document.createElement('div');
                    cell.className = 'matrix-cell attention';
                    cell.dataset.from = i;
                    cell.dataset.to = j;
                    
                    cell.addEventListener('mouseenter', (e) => showTooltip(e, i, j));
                    cell.addEventListener('mouseleave', hideTooltip);
                    grid.appendChild(cell);
                });
            });
            
            updateAttentionMatrix();
        }
        
        function updateAttentionMatrix() {
            const currentRow = attentionData.rawScores[currentWord];
            
            // Calculate step-specific values
            let displayValues;
            switch(currentStep) {
                case 0: // Raw scores
                    displayValues = currentRow;
                    break;
                case 1: // Scaled
                    displayValues = currentRow.map(score => score / 8);
                    break;
                case 2: // Pre-softmax
                    const scaled = currentRow.map(score => score / 8);
                    displayValues = scaled;
                    break;
                case 3: // Final attention (softmax)
                    const scaled2 = currentRow.map(score => score / 8);
                    const expScores = scaled2.map(score => Math.exp(score));
                    const sumExp = expScores.reduce((a, b) => a + b, 0);
                    displayValues = expScores.map(exp => exp / sumExp);
                    break;
            }
            
            // Update matrix cells
            document.querySelectorAll('.matrix-cell.attention').forEach(cell => {
                const from = parseInt(cell.dataset.from);
                const to = parseInt(cell.dataset.to);
                
                if (from === currentWord) {
                    const value = displayValues[to];
                    const normalizedValue = currentStep === 3 ? value : Math.min(value / Math.max(...displayValues), 1);
                    
                    // Color coding for accessibility
                    let bgColor;
                    if (currentStep === 3) {
                        if (value < 0.01) bgColor = '#2c3e50';
                        else if (value < 0.11) bgColor = '#95a5a6';
                        else if (value < 0.31) bgColor = '#f39c12';
                        else bgColor = '#e74c3c';
                    } else {
                        const intensity = Math.min(normalizedValue, 1);
                        const red = Math.floor(44 + intensity * 187);
                        const green = Math.floor(62 + intensity * 116);
                        const blue = Math.floor(80 + intensity * 100);
                        bgColor = `rgb(${red}, ${green}, ${blue})`;
                    }
                    
                    cell.style.backgroundColor = bgColor;
                    cell.style.color = normalizedValue > 0.5 ? 'white' : 'black';
                    cell.textContent = currentStep === 3 ? value.toFixed(3) : value.toFixed(1);
                } else {
                    cell.style.backgroundColor = '#ecf0f1';
                    cell.style.color = '#bdc3c7';
                    cell.textContent = '—';
                }
            });
        }
        
        function showTooltip(e, from, to) {
            if (from === currentWord) {
                const fromWord = sentence[from];
                const toWord = sentence[to];
                const cell = e.target;
                const value = cell.textContent;
                
                cell.title = `"${fromWord}" → "${toWord}": ${value}`;
            }
        }
        
        function hideTooltip() {
            // Tooltip handled by title attribute
        }
        
        function updateMathPanel() {
            const mathContent = document.getElementById('math-content');
            const currentWordText = sentence[currentWord];
            
            const steps = [
                {
                    title: "Step 1: Query × Key Dot Products",
                    content: `
                        <p>Computing raw attention scores for "<strong>${currentWordText}</strong>":</p>
                        <div class="formula">
score(${currentWord}, j) = q${currentWord} · kⱼ
                        </div>
                        <p>These raw scores show initial similarity between the query word and each key. Higher scores indicate stronger potential relationships.</p>
                        <p><span class="highlight">Key insight:</span> "${currentWordText}" has high similarity with "${sentence[1]}" (animal), suggesting semantic relationship.</p>
                    `
                },
                {
                    title: "Step 2: Scale by √d_k",
                    content: `
                        <p>Scaling scores to prevent saturation in softmax:</p>
                        <div class="formula">
scaled_score(${currentWord}, j) = score(${currentWord}, j) / √64 = score(${currentWord}, j) / 8
                        </div>
                        <p>This scaling (dividing by √64 = 8) prevents extremely large values that would make softmax outputs too sharp, maintaining gradient flow during training.</p>
                        <p>Notice how the relative relationships are preserved while values become more manageable.</p>
                    `
                },
                {
                    title: "Step 3: Prepare for Softmax",
                    content: `
                        <p>Scaled scores ready for normalization:</p>
                        <div class="formula">
α${currentWord},j = scaled_score(${currentWord}, j)
                        </div>
                        <p>These scaled scores will be converted to probabilities that sum to 1.0, determining how much "${currentWordText}" should attend to each word.</p>
                        <p>The highest score is for "${sentence[1]}" - the model is learning that "${currentWordText}" most likely refers to the animal!</p>
                    `
                },
                {
                    title: "Step 4: Final Attention Weights (Softmax)",
                    content: `
                        <p>Normalized attention weights for "<strong>${currentWordText}</strong>":</p>
                        <div class="formula">
α${currentWord},j = exp(scaled_score(${currentWord}, j)) / Σₖ exp(scaled_score(${currentWord}, k))
                        </div>
                        <p><span class="highlight">Key result:</span> "${currentWordText}" attends most strongly to "${sentence[1]}" (${(Math.exp(attentionData.rawScores[currentWord][1] / 8) / attentionData.rawScores[currentWord].map(s => Math.exp(s / 8)).reduce((a,b) => a + b)).toFixed(3)}), resolving the pronoun reference!</p>
                        <p>This attention pattern allows the model to incorporate "${sentence[1]}"'s meaning into "${currentWordText}"'s representation.</p>
                    `
                }
            ];
            
            mathContent.innerHTML = `
                <div class="math-step">
                    <div class="step-title">${steps[currentStep].title}</div>
                    ${steps[currentStep].content}
                </div>
            `;
        }
        
        // Step button handlers
        document.querySelectorAll('.step-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                currentStep = parseInt(e.target.dataset.step);
                
                document.querySelectorAll('.step-btn').forEach(b => b.classList.remove('active'));
                e.target.classList.add('active');
                
                const stepNames = ['Query×Key', 'Scale (÷√64)', 'Softmax', 'Final Attention'];
                document.getElementById('current-step').textContent = stepNames[currentStep];
                
                updateAttentionMatrix();
                updateMathPanel();
            });
        });
        
        // Initialize
        initializeDisplay();
    </script>
</body>
</html>